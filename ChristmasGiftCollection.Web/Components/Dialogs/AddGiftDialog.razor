@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using MudBlazor
@inject IMemberService MemberService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Legg til gaveønske</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_name"
                      Label="Gavenavn"
                      Required="true"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Class="mb-4"
                      AutoFocus="true"
                      HelperText="Hva kunne du tenke deg?" />

        <MudTextField @bind-Value="_description"
                      Label="Beskrivelse (Valgfritt)"
                      Lines="3"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Class="mb-4"
                      HelperText="Detaljer, lenker, notater..." />

        <MudText Typo="Typo.subtitle2" Class="mb-2">Prioritet</MudText>
        <MudChipSet T="GiftPriority"
                    @bind-SelectedValue="_selectedPriority"
                    Filter="true"
                    Mandatory="true"
                    Class="mb-4">
            <MudChip T="GiftPriority"
                     Value="@GiftPriority.Low"
                     Color="Color.Default"
                     SelectedColor="Color.Success"
                     Text="Lav"
                     Icon="@Icons.Material.Filled.Remove">
                Lav
            </MudChip>
            <MudChip T="GiftPriority"
                     Value="@GiftPriority.Medium"
                     Color="Color.Default"
                     SelectedColor="Color.Warning"
                     Text="Middels"
                     Icon="@Icons.Material.Filled.DragHandle"
                     Default="true">
                Middels
            </MudChip>
            <MudChip T="GiftPriority"
                     Value="@GiftPriority.High"
                     Color="Color.Default"
                     SelectedColor="Color.Error"
                     Text="Høy"
                     Icon="@Icons.Material.Filled.PriorityHigh">
                Høy
            </MudChip>
        </MudChipSet>

        <div class="d-flex gap-2 mt-4">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="Cancel">
                Avbryt
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="Submit"
                       Disabled="@_isProcessing">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Legg til gave
            </MudButton>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public Guid MemberId { get; set; }

    private string _name = string.Empty;
    private string? _description;
    private GiftPriority _selectedPriority = GiftPriority.Medium;
    private bool _isProcessing = false;

    private async Task Submit()
    {
        if (_isProcessing)
            return;

        _isProcessing = true;

        try
        {
            var giftName = string.IsNullOrWhiteSpace(_name) ? "Uten navn" : _name.Trim();
            await MemberService.AddGiftAsync(MemberId, giftName, _description?.Trim(), _selectedPriority);

            Snackbar.Add($"Gave '{giftName}' lagt til!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil ved tillegging av gave: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
