@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Web.Services
@using MudBlazor
@inject IMemberService MemberService
@inject IAuthenticationService AuthService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-2">Legg til deg selv</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Opprett profilen din for å bli med i familien
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@_errorMessage</MudAlert>
        }

        <MudTextField @bind-Value="_name"
                      Label="Ditt navn"
                      Required="true"
                      AutoFocus="true"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      HelperText="Skriv inn ditt fulle navn"
                      Class="mb-3" />

        <MudDatePicker @bind-Date="_dateOfBirth"
                       Label="Fødselsdato (Valgfritt)"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       MaxDate="DateTime.Today"
                       Class="mb-3" />

        <MudAlert Severity="Severity.Info" Class="mb-3">
            Du vil angi din 4-sifrede PIN når du logger inn første gang
        </MudAlert>

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="Cancel">
                Tilbake
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       FullWidth="true"
                       Size="Size.Large"
                       OnClick="Submit"
                       Disabled="@(string.IsNullOrWhiteSpace(_name) || _isProcessing)">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Legg meg til
            </MudButton>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private string _name = string.Empty;
    private DateTime? _dateOfBirth;
    private string _errorMessage = "";
    private bool _isProcessing = false;

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(_name) || _isProcessing)
            return;

        _isProcessing = true;
        _errorMessage = "";
        StateHasChanged();

        try
        {
            // Create the new member (they'll set PIN on first login)
            var member = await MemberService.CreateMemberAsync(
                name: _name.Trim(),
                dateOfBirth: _dateOfBirth
            );

            Snackbar.Add($"{member.Name} har blitt lagt til i familien!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(member));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Feil ved oppretting av medlem: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            StateHasChanged();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
