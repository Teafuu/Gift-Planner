@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using MudBlazor
@inject IMemberService MemberService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="_name"
        Label="Name"
        Required="true"
        Variant="Variant.Outlined"
        Margin="Margin.Dense" />

        <MudDatePicker @bind-Date="_dateOfBirth"
        Label="Date of Birth (Optional)"
        Variant="Variant.Outlined"
        Margin="Margin.Dense"
        Class="mt-3" />

        @if (_allMembers.Any())
        {
            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Relationships (Optional)</MudText>
            @foreach (var rel in _relationships)
            {
                <MudPaper Class="pa-2 mb-2" Elevation="1">
                    <MudGrid>
                        <MudItem xs="5">
                            <MudSelect @bind-Value="rel.ToMemberId"
                            Label="To Member"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            Dense="true">
                                @foreach (var member in _allMembers)
                                {
                                    <MudSelectItem Value="@member.Id">@member.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="5">
                            <MudSelect @bind-Value="rel.Type"
                            Label="Relationship"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            Dense="true">
                                <MudSelectItem Value="@RelationshipType.ChildOf">Child of</MudSelectItem>
                                <MudSelectItem Value="@RelationshipType.PartnerOf">Partner of</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="2" Class="d-flex align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                            Color="Color.Error"
                            Size="Size.Small"
                            OnClick="@(() => _relationships.Remove(rel))" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            }

            <MudButton StartIcon="@Icons.Material.Filled.Add"
            Color="Color.Primary"
            Variant="Variant.Text"
            OnClick="AddRelationship"
            Class="mt-2">
                Add Relationship
            </MudButton>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary"
        Variant="Variant.Filled"
        OnClick="Submit"
        Disabled="@(string.IsNullOrWhiteSpace(_name))">
            Add Member
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private string _name = string.Empty;
    private DateTime? _dateOfBirth;
    private List<Member> _allMembers = new();
    private List<RelationshipInput> _relationships = new();

    protected override async Task OnInitializedAsync()
    {
        _allMembers = (await MemberService.GetAllMembersAsync()).ToList();
    }

    private void AddRelationship()
    {
        _relationships.Add(new RelationshipInput());
    }

    private async Task Submit()
    {
        try
        {
            var member = await MemberService.CreateMemberAsync(
                name: _name,
                email: null,
                dateOfBirth: _dateOfBirth,
                notes: null
            );

            foreach(var relationship in _relationships){
                await MemberService.AddRelationshipAsync(member.Id, relationship.ToMemberId, relationship.Type);
            }

            Snackbar.Add($"Member '{_name}' added successfully!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(member));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding member: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private class RelationshipInput
    {
        public Guid ToMemberId { get; set; }
        public RelationshipType Type { get; set; } = RelationshipType.ChildOf;
    }
}
