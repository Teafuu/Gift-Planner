@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Web.Services
@using MudBlazor
@inject IMemberService MemberService
@inject ISecretSantaService SecretSantaService
@inject IAuthenticationService AuthService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Opprett Gave trekkning</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Sett opp en ny Secret Santa gaveutveksling
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">@_errorMessage</MudAlert>
        }

        @if (_isLoading)
        {
            <div class="d-flex justify-center align-center pa-6">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else
        {
            <MudTextField @bind-Value="_raffleName"
                          Label="Navn på trekning"
                          Required="true"
                          AutoFocus="true"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          HelperText="f.eks., 'Jul 2025', 'Familie Hemmelig Nisse'"
                          Class="mb-3" />

            <MudNumericField @bind-Value="_year"
                             Label="År"
                             Required="true"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="2024"
                             Max="2099"
                             Class="mb-3" />

            <MudNumericField @bind-Value="_budget"
                             Label="Budsjett (Valgfritt)"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="0"
                             Prefix="kr"
                             Step="50"
                             HelperText="Foreslått utgiftsgrense per person"
                             Class="mb-3" />

            <MudText Typo="Typo.subtitle2" Class="mb-2">Velg deltakere (Må være flere enn én)</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                Valgt: @_selectedParticipants.Count
            </MudText>

            <div style="max-height: 300px; overflow-y: auto;" class="mb-3">
                @foreach (var member in _allMembers)
                {
                    <MudCheckBox @bind-Value="@_participantSelection[member.Id]"
                                 Label="@member.Name"
                                 Color="Color.Primary"
                                 Dense="true" />
                }
            </div>

            @if (_selectedParticipants.Count < 2)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3">
                    Vennligst velg minst to deltakere.
                </MudAlert>
            }

            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           FullWidth="true"
                           Size="Size.Large"
                           OnClick="Cancel"
                           Disabled="_isProcessing">
                    Avbryt
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           FullWidth="true"
                           Size="Size.Large"
                           OnClick="Submit"
                           Disabled="@(!CanSubmit())">
                    @if (_isProcessing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Opprett
                </MudButton>
            </div>
        }
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private string _raffleName = string.Empty;
    private int _year = DateTime.Now.Year;
    private decimal? _budget;
    private string _errorMessage = "";
    private bool _isProcessing = false;
    private bool _isLoading = true;

    private List<Member> _allMembers = new();
    private Dictionary<Guid, bool> _participantSelection = new();
    private List<Guid> _selectedParticipants => _participantSelection.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadMembers();
    }

    private async Task LoadMembers()
    {
        try
        {
            _isLoading = true;
            _allMembers = (await MemberService.GetAllMembersAsync()).ToList();

            // Initialize selection dictionary
            foreach (var member in _allMembers)
            {
                _participantSelection[member.Id] = false;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Kunne ikke laste medlemmer: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool CanSubmit()
    {
        return !string.IsNullOrWhiteSpace(_raffleName) &&
               _selectedParticipants.Count >= 2 &&
               !_isProcessing;
    }

    private async Task Submit()
    {
        if (!CanSubmit())
            return;

        _isProcessing = true;
        _errorMessage = "";

        try
        {
            var currentMemberId = AuthService.GetCurrentMemberId();
            if (!currentMemberId.HasValue)
            {
                _errorMessage = "Du må være logget inn for å opprette en trekning";
                return;
            }

            // Create the raffle
            var raffle = await SecretSantaService.CreateRaffleAsync(
                _raffleName,
                _selectedParticipants,
                _budget,
                currentMemberId.Value,
                _year);

            // Execute the raffle immediately to generate assignments
            await SecretSantaService.ExecuteRaffleAsync(raffle.Id);

            Snackbar.Add($"Hemmelig Nisse '{_raffleName}' opprettet!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(raffle));
        }
        catch (Exception ex)
        {
            _errorMessage = $"Kunne ikke opprette trekning: {ex.Message}";
            Snackbar.Add($"Feil: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
