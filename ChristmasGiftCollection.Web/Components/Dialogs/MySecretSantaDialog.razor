@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Web.Services
@using MudBlazor
@inject IMemberService MemberService
@inject ISecretSantaService SecretSantaService
@inject IAuthenticationService AuthService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">üéÖ Secret Santa oppgaver</MudText>
    </TitleContent>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex justify-center align-center pa-6">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else if (!_myAssignments.Any())
        {
            <MudAlert Severity="Severity.Info">
                Du deltar ikke i noen Hemmelig Nisse trekninger for √∏yeblikket.
            </MudAlert>
        }
        else
        {
            <MudStack Spacing="3">
                @foreach (var assignment in _myAssignments)
                {
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-2">@assignment.RaffleName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                √Ör: @assignment.Year
                            </MudText>

                            @if (assignment.Budget.HasValue)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                                    Budsjett: kr @assignment.Budget.Value.ToString("F2")
                                </MudText>
                            }

                            <MudDivider Class="my-2" />

                            <MudText Typo="Typo.subtitle1" Class="mb-1">
                                üéÅ Du skal gi gave til:
                            </MudText>
                            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                                @assignment.RecipientName
                            </MudText>

                            @if (assignment.RecipientGiftCount > 0)
                            {
                                <MudButton Variant="Variant.Text"
                                Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.Forest"
                                OnClick="@(() => ViewRecipientGifts(assignment.RecipientId, assignment.RecipientName))">
                                    Se √∏nskelisten deres (@assignment.RecipientGiftCount @(assignment.RecipientGiftCount == 1 ? "gave" : "gaver"))
                                </MudButton>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Ingen gave√∏nsker lagt til enn√•
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }

        <div class="mt-4">
            <MudButton Variant="Variant.Filled"
            Color="Color.Primary"
            FullWidth="true"
            OnClick="Close">
                Lukk
            </MudButton>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public EventCallback<Guid> OnViewMemberDetails { get; set; }

    private bool _isLoading = true;
    private List<AssignmentViewModel> _myAssignments = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMyAssignments();
    }

    private async Task LoadMyAssignments()
    {
        try
        {
            _isLoading = true;

            var currentMemberId = AuthService.GetCurrentMemberId();
            if (!currentMemberId.HasValue)
            {
                return;
            }

            // Get all raffles this member is participating in
            var raffles = await SecretSantaService.GetRafflesForMemberAsync(currentMemberId.Value);

            // Build view models with recipient information
            foreach (var raffle in raffles.Where(r => r.IsExecuted && !r.IsCancelled))
            {
                if (raffle.Assignments.TryGetValue(currentMemberId.Value, out var recipientId))
                {
                    var recipient = await MemberService.GetMemberByIdAsync(recipientId);
                    if (recipient != null)
                    {
                        _myAssignments.Add(new AssignmentViewModel
                        {
                            RaffleId = raffle.Id,
                            RaffleName = raffle.Name,
                            Year = raffle.Year,
                            Budget = raffle.Budget,
                            RecipientId = recipient.Id,
                            RecipientName = recipient.Name,
                            RecipientGiftCount = recipient.Gifts.Count
                        });
                    }
                }
            }

            // Sort by year descending
            _myAssignments = _myAssignments.OrderByDescending(a => a.Year).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Feil ved lasting av oppdrag: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ViewRecipientGifts(Guid recipientId, string recipientName)
    {
        // Close this dialog and trigger member details
        MudDialog.Close();
        await OnViewMemberDetails.InvokeAsync(recipientId);
        StateHasChanged();
    }

    private void Close()
    {
        MudDialog.Close();
    }

    private class AssignmentViewModel
    {
        public Guid RaffleId { get; set; }
        public string RaffleName { get; set; } = string.Empty;
        public int Year { get; set; }
        public decimal? Budget { get; set; }
        public Guid RecipientId { get; set; }
        public string RecipientName { get; set; } = string.Empty;
        public int RecipientGiftCount { get; set; }
    }
}
