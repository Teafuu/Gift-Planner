@inject IJSRuntime JS
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Core.Models
@using Microsoft.JSInterop
@inject IMemberService MemberService
@implements IAsyncDisposable

<div id="family-graph" style="width: 100%; height: 100%;"></div>

@code {
    [Parameter] public EventCallback<Guid> OnNodeClicked { get; set; }

    private IJSObjectReference? _module;
    private DotNetObjectReference<FamilyGraph>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/familyGraph.js");
            await InitializeGraphAsync();
        }
    }

    public async Task RefreshAsync()
    {
        await InitializeGraphAsync();
    }

    private async Task InitializeGraphAsync()
    {
        if (_module != null)
        {
            try
            {
                // Load real data from event sourcing
                var members = await MemberService.GetAllMembersAsync();
                var graphData = BuildGraphData(members);
                await _module.InvokeVoidAsync("initializeGraph", "family-graph", graphData, _objRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing graph: {ex.Message}");
                // Initialize with empty data on error
                var emptyData = new { nodes = Array.Empty<object>(), edges = Array.Empty<object>() };
                await _module.InvokeVoidAsync("initializeGraph", "family-graph", emptyData, _objRef);
            }
        }
    }

    private object BuildGraphData(IEnumerable<Member> members)
    {
        var nodes = members.Select(m => new
        {
            id = m.Id.ToString(),
            label = m.Name,
            title = $"{m.Name}\nClick to view gifts and details",
            giftCount = m.Gifts.Count
        }).ToList();

        var edges = members
            .SelectMany(m => m.Relationships.Select(r => new
            {
                from = r.FromMemberId.ToString(),
                to = r.ToMemberId.ToString(),
                label = r.Type.ToString().Replace("Of", " of "),
                arrows = "to"
            }))
            .ToList();

        return new { nodes, edges };
    }

    [JSInvokable]
    public async Task OnNodeClick(string nodeId)
    {
        if (Guid.TryParse(nodeId, out var memberId))
        {
            await OnNodeClicked.InvokeAsync(memberId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_module != null)
            {
                await _module.DisposeAsync();
            }
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected during disposal - this is expected and can be safely ignored
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing graph module: {ex.Message}");
        }
        finally
        {
            _objRef?.Dispose();
        }
    }
}
