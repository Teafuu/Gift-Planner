@inject IJSRuntime JS
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Core.Models
@inject IMemberService MemberService
@implements IAsyncDisposable

<div id="family-graph" style="width: 100%; height: 520px; position: relative;"></div>

@code {
    private IJSObjectReference? _module;
    private DotNetObjectReference<FamilyGraph>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/familyGraph.js");

            // Initialize with sample data for Phase 2
            await InitializeGraphAsync();
        }
    }

    private async Task InitializeGraphAsync()
    {
        if (_module != null)
        {
            // TODO: Load real data from event sourcing
            // var members = await MemberService.GetAllMembersAsync();
            // var graphData = BuildGraphData(members);
            // await _module.InvokeVoidAsync("initializeGraph", "family-graph", graphData, _objRef);

            // For now, use sample data
            var sampleData = GetSampleData();
            await _module.InvokeVoidAsync("initializeGraph", "family-graph", sampleData, _objRef);
        }
    }

    private object GetSampleData()
    {
        return new
        {
            nodes = new[]
            {
                new { id = 2, label = "Mary", group = "adult", title = "Click to view details" },
                new { id = 3, label = "Sarah", group = "child", title = "Click to view details" },
                new { id = 4, label = "Tom", group = "child", title = "Click to view details" }
            },
            edges = new[]
            {
                new { from = 2, to = 3, label = "parent", arrows = "to" },
                new { from = 2, to = 4, label = "parent", arrows = "to" }
            }
        };
    }

    [JSInvokable]
    public void OnNodeClick(int nodeId)
    {
        // Will be implemented in Phase 5 - Member Management UI
        Console.WriteLine($"Node clicked: {nodeId}");
    }

    [JSInvokable]
    public void OnNodeDoubleClick(int nodeId)
    {
        // Will be implemented in Phase 5 - Member Management UI
        Console.WriteLine($"Node double-clicked: {nodeId}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            await _module.DisposeAsync();
        }
        _objRef?.Dispose();
    }
}
