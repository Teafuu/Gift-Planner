@page "/"
@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Web.Components.Dialogs
@rendermode InteractiveServer
@inject IMemberService MemberService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Family Gift Collection 2025</PageTitle>

<style>
    .full-screen-graph {
    position: fixed;
    top: 64px; /* Account for MudAppBar */
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    }

    .fab-add-member {
    position: fixed !important;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    }
</style>

<!-- Full-screen Family Graph -->
<div class="full-screen-graph">
    <FamilyGraph @ref="_graphComponent" OnNodeClicked="HandleNodeClicked" />
</div>

<!-- Floating Action Button for Add Member -->
<MudFab Color="Color.Primary"
StartIcon="@Icons.Material.Filled.PersonAdd"
Label="Add Member"
Class="fab-add-member"
OnClick="OpenAddMemberDialog" />

@code {
    private FamilyGraph? _graphComponent;

    private async Task OpenAddMemberDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<AddMemberDialog>("Add Family Member", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add("Member added successfully!", Severity.Success);
            await RefreshGraph();
        }
    }

    private async Task HandleNodeClicked(Guid memberId)
    {
        var parameters = new DialogParameters<MemberDetailsDialog>
        {
            { x => x.MemberId, memberId }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<MemberDetailsDialog>("Member Details", parameters, options);
        await dialog.Result;
    }

    private async Task RefreshGraph()
    {
        if (_graphComponent != null)
        {
            await _graphComponent.RefreshAsync();
        }
    }
}
