@page "/"
@using ChristmasGiftCollection.Core.Models
@using ChristmasGiftCollection.Core.Services
@using ChristmasGiftCollection.Web.Components.Dialogs
@using ChristmasGiftCollection.Web.Components.Layout
@using ChristmasGiftCollection.Web.Services
@rendermode InteractiveServer
@inject IMemberService MemberService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Gaver</PageTitle>

<style>
    .full-screen-graph {
    position: fixed;
    top: 64px; /* Account for MudAppBar */
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
    }
</style>

<!-- Full-screen Family Graph -->
<div class="full-screen-graph">
    <FamilyGraph @ref="_graphComponent" OnNodeClicked="HandleNodeClicked" />
</div>

@code {
    private FamilyGraph? _graphComponent;

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    protected override void OnInitialized()
    {
        // Register callback with MainLayout for when login completes
        Layout!.RegisterLoginCompletedCallback(HandleLoginCompleted);
        Layout!.FamilyMemberChanged += HandleFamilyMemberChanged;
    }

    private async Task HandleLoginCompleted()
    {
        // Wait a bit for the graph to be ready, then focus on current member
        await Task.Delay(500);
        if (_graphComponent != null && AuthService.IsAuthenticated())
        {
            await _graphComponent.FocusOnCurrentMemberAsync(AuthService.GetCurrentMemberId()!.Value);
        }
    }

    private async void HandleFamilyMemberChanged(Guid memberId)
    {
        await ShowMemberDetailsDialog(memberId);
    }

    private async Task HandleNodeClicked(Guid memberId)
    {
        await ShowMemberDetailsDialog(memberId);
    }

    private Guid? _currentlyOpenDialogMemberId;

    private async Task ShowMemberDetailsDialog(Guid memberId)
    {
        await _graphComponent.FocusOnCurrentMemberAsync(memberId);
        _currentlyOpenDialogMemberId = memberId;

        var parameters = new DialogParameters<MemberDetailsDialog>
        {
            { x => x.MemberId, memberId },
            { x => x.OnMemberChanged, EventCallback.Factory.Create<OnMemberChangedEvent>(this, HandleMemberChanged) }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<MemberDetailsDialog>("Familiemedlem", parameters, options);
        _currentlyOpenDialogMemberId = null;
    }

    private async Task HandleMemberChanged(OnMemberChangedEvent member)
    {
        if (member.shouldRefreshGraph)
            await RefreshGraph();

        // Only reopen dialog if it's a different member (e.g., navigating to a relationship)
        // Don't reopen if we're just updating the same member's details
        if (_currentlyOpenDialogMemberId.HasValue && member.memberId != _currentlyOpenDialogMemberId.Value)
        {
            await ShowMemberDetailsDialog(member.memberId);
        }else
        {
            await _graphComponent.FocusOnCurrentMemberAsync(member.memberId);

        }
    }

    private async Task RefreshGraph()
    {
        if (_graphComponent != null)
        {
            await _graphComponent.RefreshAsync();
        }
    }

    public record OnMemberChangedEvent(Guid memberId, bool shouldRefreshGraph);
}
